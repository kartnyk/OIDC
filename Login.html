<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" content="${_csrf.token}">
    <meta name="_csrf_header" content="${_csrf.headerName}">
    <title>Custom OIDC Login Page</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title text-center">Sign In to Continue</h3>
                    <!-- Username and Password Form -->
                    <form id="loginForm" onsubmit="return handleLogin(event)">
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Sign In</button>
                    </form>
                    <hr>
                    <h5 class="text-center">OR</h5>
                    <a href="/login/oauth2/authorization/google" class="btn btn-google btn-block">Continue with Google</a>
                    <a href="/login/oauth2/authorization/authe" class="btn btn-authe btn-block">Continue with Authe</a>
                </div>
                <div class="card-footer text-center">
                    <small><a href="#">Sign up</a></small>
                    <br>
                    <small><a href="#">Terms of Service</a> &middot; <a href="#">Privacy Policy</a></small>
                </div>
            </div>
            <!-- Display error message -->
            <div class="mt-3">
                <div class="alert alert-danger text-center" role="alert" style="display: none;" id="errorAlert">
                    <h4 class="alert-heading">Authentication Error</h4>
                    <p id="errorMessage"></p>
                    <hr>
                    <a href="/login" class="btn btn-primary">Back to Login</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script>
    async function handleLogin(event) {
        event.preventDefault();
        const usernameField = document.getElementById('username');
        const passwordField = document.getElementById('password');
        const username = usernameField.value;
        const password = passwordField.value;

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ username, password })
            });

            const message = await response.text();
            if (response.ok) {
                alert('Login successful: ' + message);
            } else {
                alert('Login failed: ' + message);
            }
        } catch (error) {
            alert('Login failed: ' + error.message);
        }

        // Re-enable and clear the fields
        usernameField.value = '';
        passwordField.value = '';
    }
</script>

</body>
</html>
